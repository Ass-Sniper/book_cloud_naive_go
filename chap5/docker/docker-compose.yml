# docker-compose.yml

services:
  app:
    container_name: kvstore-app   # 👈 显式指定容器名称
    build:
      context: ..                  # 👈 指向项目根目录
      dockerfile: docker/Dockerfile
    environment:
      - TZ=Asia/Shanghai
    ports:
      - "8080:8080"  # 主业务接口
      - "6060:6060"  # pprof 接口
    networks:
      - kvstore_net
    healthcheck:
      # 检查业务服务是否正常（8080 端口）
      test: ["CMD", "curl", "-f", "http://0.0.0.0:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  nginx:
    container_name: kvstore-nginx  # 👈 显式指定容器名称
    build:
      context: ..  # 使用上级目录作为上下文
      dockerfile: config/nginx/Dockerfile.nginx  # 指定 Dockerfile 的路径
    ports:
      - "80:80"  # 将 nginx 对外暴露在 80 端口
      - "443:443"  # 将 nginx 对外暴露在 443 端口
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ../config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../config/nginx/certs:/etc/nginx/certs
    healthcheck:
      # 检查业务服务是否正常（80 端口）
      test: ["CMD", "curl", "-f", "http://0.0.0.0:80/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - kvstore_net

networks:
  kvstore_net:
    driver: bridge
    attachable: true