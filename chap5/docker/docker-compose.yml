# docker-compose.yml

services:
  app:
    container_name: kvstore-app   # ğŸ‘ˆ æ˜¾å¼æŒ‡å®šå®¹å™¨åç§°
    build:
      context: ..                  # ğŸ‘ˆ ä»¥docker-compose.ymlæ‰€åœ¨ç›®å½•çš„ä¸Šçº§ç›®å½•ï¼ˆ../ï¼‰ä½œä¸ºé¡¹ç›®æ ¹ç›®å½•
      dockerfile: docker/Dockerfile
    develop:
      watch:
        - action: sync
          path: ../web
          target: /app/web
        - action: sync+restart
          path: ../config/config.json     # appé…ç½®æ–‡ä»¶
          target: /app/config/config.json
        - action: sync+restart
          path: ../config/locales        # appæœ¬åœ°åŒ–é…ç½®æ–‡ä»¶ï¼šç¿»è¯‘æ–‡ä»¶
          target: /app/config/locales               
        - action: rebuild
          path: ../cmd
        - action: rebuild
          path: ../interval        
    environment:
      - TZ=Asia/Shanghai
    ports:
      - "8080:8080"  # ä¸»ä¸šåŠ¡æ¥å£
      - "6060:6060"  # pprof æ¥å£
    networks:
      - kvstore_net
    healthcheck:
      # æ£€æŸ¥ä¸šåŠ¡æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼ˆ8080 ç«¯å£ï¼‰
      test: ["CMD", "curl", "-f", "http://0.0.0.0:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  nginx:
    container_name: kvstore-nginx  # ğŸ‘ˆ æ˜¾å¼æŒ‡å®šå®¹å™¨åç§°
    build:
      context: ..  # ä»¥docker-compose.ymlæ‰€åœ¨ç›®å½•çš„ä¸Šçº§ç›®å½•ï¼ˆ../ï¼‰ä½œä¸ºä¸Šä¸‹æ–‡
      dockerfile: config/nginx/Dockerfile.nginx  # æŒ‡å®š Dockerfile çš„è·¯å¾„
    develop:
      watch:
        - action: sync+restart
          path: ../config/nginx
          target: /etc/nginx
    ports:
      - "80:80"  # å°† nginx å¯¹å¤–æš´éœ²åœ¨ 80 ç«¯å£
      - "443:443"  # å°† nginx å¯¹å¤–æš´éœ²åœ¨ 443 ç«¯å£
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ../config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../config/nginx/certs:/etc/nginx/certs
    healthcheck:
      # æ£€æŸ¥ä¸šåŠ¡æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼ˆ80 ç«¯å£ï¼‰
      test: ["CMD", "curl", "-f", "http://0.0.0.0:80/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - kvstore_net

networks:
  kvstore_net:
    driver: bridge
    attachable: true