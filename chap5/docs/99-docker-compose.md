
# Introduction to Docker Compose

---

## Docker Compose å¦‚ä½•å·¥ä½œï¼Ÿ

ä½¿ç”¨ Docker Compose æ—¶ï¼Œä½ éœ€è¦ç¼–å†™ä¸€ä¸ª YAML é…ç½®æ–‡ä»¶ï¼ˆç§°ä¸º Compose æ–‡ä»¶ï¼‰æ¥é…ç½®åº”ç”¨çš„å„ä¸ªæœåŠ¡ï¼Œç„¶åé€šè¿‡ Compose CLIï¼ˆå‘½ä»¤è¡Œç•Œé¢ï¼‰æ¥åˆ›å»ºå¹¶å¯åŠ¨è¿™äº›æœåŠ¡ã€‚

Compose æ–‡ä»¶ï¼ˆé€šå¸¸å‘½åä¸º `compose.yaml`ï¼‰éµå¾ª [Compose è§„èŒƒï¼ˆCompose Specificationï¼‰](https://github.com/compose-spec/compose-spec)ï¼Œç”¨äºæè¿°å¤šå®¹å™¨åº”ç”¨çš„ç»“æ„ã€‚Docker Compose æ˜¯è¯¥è§„èŒƒçš„ä¸€ä¸ªå…·ä½“å®ç°ã€‚

---

### ğŸ§© Compose åº”ç”¨æ¨¡å‹

#### ğŸ“„ Compose æ–‡ä»¶

é»˜è®¤çš„ Compose æ–‡ä»¶è·¯å¾„ä¸º `compose.yaml`ï¼ˆæ¨èï¼‰ï¼Œæˆ–å…¼å®¹æ—§ç‰ˆæœ¬çš„ `compose.yml`ã€‚æ­¤å¤–ï¼Œä¹Ÿæ”¯æŒ `docker-compose.yaml` å’Œ `docker-compose.yml` ä½œä¸ºå†å²å…¼å®¹ã€‚å¦‚æœå¤šä¸ªæ–‡ä»¶åŒæ—¶å­˜åœ¨ï¼ŒCompose ä¼˜å…ˆä½¿ç”¨ `compose.yaml`ã€‚

ä¸ºäº†æé«˜å¯ç»´æŠ¤æ€§å’Œå¤ç”¨æ€§ï¼ŒCompose æ”¯æŒä½¿ç”¨ç‰‡æ®µï¼ˆfragmentsï¼‰å’Œæ‰©å±•ï¼ˆextensionsï¼‰ã€‚

ä½ è¿˜å¯ä»¥åˆå¹¶å¤šä¸ª Compose æ–‡ä»¶æ¥å®šä¹‰åº”ç”¨æ¨¡å‹ã€‚å¤šä¸ª YAML æ–‡ä»¶å°†æ ¹æ®ä½ è®¾å®šçš„é¡ºåºåˆå¹¶ï¼š

* ç®€å•å±æ€§å’Œæ˜ å°„ä¼šè¢«é¡ºåºä¸­ä¼˜å…ˆçš„æ–‡ä»¶è¦†ç›–ï¼›
* åˆ—è¡¨ä¼šé€šè¿‡è¿½åŠ åˆå¹¶ï¼›
* ç›¸å¯¹è·¯å¾„å°†ä»¥ç¬¬ä¸€ä¸ª Compose æ–‡ä»¶çš„çˆ¶ç›®å½•ä¸ºåŸºç¡€è¿›è¡Œè§£æã€‚

å¯¹äºé‚£äº›æ—¢å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯å¤æ‚å¯¹è±¡çš„é…ç½®é¡¹ï¼ŒCompose ä¼šå…ˆå°†å…¶æ‰©å±•ä¸ºç»Ÿä¸€å½¢å¼å†æ‰§è¡Œåˆå¹¶ã€‚

ğŸ”— å‚è§ï¼š[Working with multiple Compose files](https://docs.docker.com/compose/extends/)

æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³å¤ç”¨å…¶ä»– Compose æ–‡ä»¶ï¼Œæˆ–å°†å¤§å‹åº”ç”¨æ‹†åˆ†ä¸ºå¤šä¸ª Compose æ–‡ä»¶æ¨¡å—ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `include` åŠŸèƒ½ã€‚è¿™å¯¹äºè·¨å›¢é˜Ÿåä½œæˆ–å…±äº«é…ç½®ç‰¹åˆ«æœ‰ç”¨ã€‚

---

### ğŸ§° CLIï¼šå‘½ä»¤è¡Œå·¥å…·

Docker æä¾›äº† `docker compose` å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç®¡ç†é€šè¿‡ Compose å®šä¹‰çš„å¤šå®¹å™¨åº”ç”¨ã€‚

ä½ å¯ä»¥é€šè¿‡ CLI æ¥ï¼š

* å¯åŠ¨æœåŠ¡
* åœæ­¢æœåŠ¡
* æŸ¥çœ‹çŠ¶æ€
* ç®¡ç†æ—¥å¿—
* è°ƒè¯•æœåŠ¡ç­‰

#### å…³é”®å‘½ä»¤

```bash
# å¯åŠ¨ compose.yaml ä¸­å®šä¹‰çš„æ‰€æœ‰æœåŠ¡
docker compose up

# åœæ­¢å¹¶ç§»é™¤æ­£åœ¨è¿è¡Œçš„æœåŠ¡åŠå…¶èµ„æº
docker compose down

# æŸ¥çœ‹å®¹å™¨è¾“å‡ºæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
docker compose logs

# åˆ—å‡ºæ‰€æœ‰æœåŠ¡åŠå…¶å½“å‰çŠ¶æ€
docker compose ps
```

å®Œæ•´å‘½ä»¤å‚è€ƒæ–‡æ¡£è§ï¼š[Compose CLI å‘½ä»¤æ–‡æ¡£](https://docs.docker.com/compose/reference/)

---

### ğŸ’¡ ç¤ºä¾‹è¯´æ˜

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº† Compose çš„æ ¸å¿ƒæ¦‚å¿µã€‚è®¾æƒ³ä½ æœ‰ä¸€ä¸ªåŒ…å«å‰ç«¯å’Œåç«¯çš„ Web åº”ç”¨ï¼š

* å‰ç«¯æœåŠ¡éƒ¨ç½²åœ¨ HTTPS ä¸Šï¼Œé…ç½®æ–‡ä»¶ä¸è¯ä¹¦ç”±å¹³å°åŸºç¡€è®¾æ–½æ³¨å…¥ï¼›
* åç«¯æœåŠ¡ä¿å­˜æ•°æ®åœ¨ä¸€ä¸ªæŒä¹…åŒ–å·ä¸­ï¼›
* ä¸¤è€…é€šè¿‡ç§æœ‰ç½‘ç»œé€šä¿¡ï¼Œå‰ç«¯åŒæ—¶æš´éœ²ç«¯å£ 443 ç”¨äºå¤–éƒ¨è®¿é—®ã€‚

![Docker Compose åº”ç”¨ç»“æ„å›¾](https://docs.docker.com/compose/images/compose-application.webp)

#### ğŸ§± Compose åº”ç”¨æ¨¡å‹ç¤ºä¾‹

```yaml
services:
  frontend:
    image: example/webapp
    ports:
      - "443:8043"
    networks:
      - front-tier
      - back-tier
    configs:
      - httpd-config
    secrets:
      - server-certificate

  backend:
    image: example/database
    volumes:
      - db-data:/etc/data
    networks:
      - back-tier

volumes:
  db-data:
    driver: flocker
    driver_opts:
      size: "10GiB"

configs:
  httpd-config:
    external: true

secrets:
  server-certificate:
    external: true

networks:
  front-tier: {}
  back-tier: {}
```

`docker compose up` ä¼šå®Œæˆä»¥ä¸‹æ“ä½œï¼š

* å¯åŠ¨ `frontend` å’Œ `backend` æœåŠ¡ï¼›
* åˆ›å»ºæ‰€éœ€çš„ç½‘ç»œä¸æ•°æ®å·ï¼›
* å°†é…ç½®å’Œè¯ä¹¦æ³¨å…¥å‰ç«¯æœåŠ¡ã€‚

è¿è¡ŒçŠ¶æ€æ£€æŸ¥ç¤ºä¾‹ï¼š

```bash
$ docker compose ps

NAME                IMAGE                COMMAND                 SERVICE   CREATED          STATUS          PORTS
frontend-1          example/webapp       "nginx ..."             frontend  2 minutes ago    Up 2 minutes    0.0.0.0:443->8043/tcp
backend-1           example/database     "docker-entrypoint..."  backend   2 minutes ago    Up 2 minutes
```

---

## æ¥ä¸‹æ¥ä½ å¯ä»¥åšä»€ä¹ˆï¼Ÿ

* è¯•è¯• [Compose å¿«é€Ÿä¸Šæ‰‹](https://docs.docker.com/compose/gettingstarted/)
* æµè§ˆ [ç¤ºä¾‹åº”ç”¨](https://github.com/docker/awesome-compose)
* ç†Ÿæ‚‰ [Compose è§„èŒƒ](https://compose-spec.io/)

---

## ä¸ºä»€ä¹ˆä½¿ç”¨ Docker Composeï¼Ÿ

### Docker Compose çš„ä¸»è¦ä¼˜åŠ¿

ä½¿ç”¨ Docker Compose å¯ä»¥ç®€åŒ–å®¹å™¨åŒ–åº”ç”¨çš„å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†æµç¨‹ï¼Œä¸»è¦ä¼˜ç‚¹åŒ…æ‹¬ï¼š

#### âœ… ç®€åŒ–æ§åˆ¶

Docker Compose å…è®¸ä½ é€šè¿‡ä¸€ä¸ª YAML æ–‡ä»¶æ¥å®šä¹‰å’Œç®¡ç†å¤šå®¹å™¨åº”ç”¨ã€‚å®ƒç®€åŒ–äº†å¤šä¸ªæœåŠ¡ä¹‹é—´çš„ç¼–æ’ä¸åè°ƒï¼Œä½¿å¾—åº”ç”¨ç¯å¢ƒçš„ç®¡ç†å’Œå¤åˆ¶å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

#### âœ… é«˜æ•ˆåä½œ

Docker Compose çš„é…ç½®æ–‡ä»¶æ˜“äºå…±äº«ï¼Œæœ‰åŠ©äºå¼€å‘äººå‘˜ã€è¿ç»´å›¢é˜ŸåŠå…¶ä»–ç›¸å…³äººå‘˜ä¹‹é—´çš„åä½œã€‚è¿™ç§å…±äº«é…ç½®å¸¦æ¥äº†æ›´é¡ºç•…çš„å·¥ä½œæµç¨‹ã€æ›´å¿«çš„é—®é¢˜è§£å†³æ•ˆç‡ä»¥åŠæ•´ä½“ç”Ÿäº§æ•ˆç‡çš„æå‡ã€‚

#### âœ… å¿«é€Ÿçš„åº”ç”¨å¼€å‘

Compose ä¼šç¼“å­˜åˆ›å»ºå®¹å™¨æ‰€ç”¨çš„é…ç½®ã€‚å½“ä½ é‡å¯ä¸€ä¸ªæœªè¢«ä¿®æ”¹çš„æœåŠ¡æ—¶ï¼ŒCompose ä¼šå¤ç”¨ç°æœ‰å®¹å™¨ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºã€‚é€šè¿‡å®¹å™¨é‡ç”¨ï¼Œä½ å¯ä»¥éå¸¸å¿«é€Ÿåœ°å¯¹ç¯å¢ƒè¿›è¡Œæ›´æ”¹ã€‚

#### âœ… è·¨ç¯å¢ƒå¯ç§»æ¤æ€§

Compose æ–‡ä»¶ä¸­æ”¯æŒä½¿ç”¨å˜é‡ã€‚ä½ å¯ä»¥å€ŸåŠ©å˜é‡æ¥ä¸ºä¸åŒçš„ç¯å¢ƒæˆ–ç”¨æˆ·è‡ªå®šä¹‰ Compose é…ç½®ï¼Œä»è€Œå®ç°ç¯å¢ƒä¹‹é—´çš„ä¾¿æ·è¿ç§»ã€‚

#### âœ… ä¸°å¯Œçš„ç¤¾åŒºä¸æ”¯æŒ

Docker Compose æ‹¥æœ‰ä¸€ä¸ªæ´»è·ƒçš„å¼€æºç¤¾åŒºï¼Œå› æ­¤ä½ å¯ä»¥è·å¾—å¤§é‡çš„å­¦ä¹ èµ„æºã€æ•™ç¨‹å’ŒæŠ€æœ¯æ”¯æŒã€‚ç¤¾åŒºçš„æ´»è·ƒä¹Ÿæ¨åŠ¨äº† Compose çš„æŒç»­æ”¹è¿›ï¼ŒåŒæ—¶å¸®åŠ©ç”¨æˆ·é«˜æ•ˆæ’æŸ¥é—®é¢˜ã€‚

---

### Docker Compose çš„å¸¸è§ä½¿ç”¨åœºæ™¯

Docker Compose å¯ä»¥åœ¨å¤šç§åœºæ™¯ä¸­ä½¿ç”¨ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹ä¾‹å­ï¼š

#### ğŸ› ï¸ å¼€å‘ç¯å¢ƒ

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œèƒ½åœ¨éš”ç¦»ç¯å¢ƒä¸­è¿è¡Œå’Œäº¤äº’åº”ç”¨æ˜¯éå¸¸é‡è¦çš„ã€‚Compose å‘½ä»¤è¡Œå·¥å…·å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿåˆ›å»ºè¿™æ ·çš„ç¯å¢ƒã€‚

Compose æ–‡ä»¶ç”¨äºè®°å½•å’Œé…ç½®åº”ç”¨çš„æ‰€æœ‰æœåŠ¡ä¾èµ–ï¼ˆå¦‚æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜ã€Web æœåŠ¡ API ç­‰ï¼‰ã€‚ä½ åªéœ€ä¸€æ¡å‘½ä»¤ï¼š

```
docker compose up
```

å°±å¯ä»¥ä¸ºæ¯ä¸ªä¾èµ–å¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥å°†åŸæœ¬éœ€è¦å‡ é¡µè¯´æ˜æ–‡æ¡£æ‰èƒ½å®Œæˆçš„ã€Œå¼€å‘ç¯å¢ƒé…ç½®ã€ï¼Œç®€åŒ–ä¸ºä¸€ä¸ª Compose æ–‡ä»¶å’Œå‡ æ¡å‘½ä»¤ã€‚

---

#### ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•ç¯å¢ƒ

åœ¨æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰æˆ–æŒç»­é›†æˆï¼ˆCIï¼‰æµç¨‹ä¸­ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•æ˜¯è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚Compose æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥ä¸ºä½ çš„æµ‹è¯•å¥—ä»¶åˆ›å»ºå’Œé”€æ¯éš”ç¦»çš„æµ‹è¯•ç¯å¢ƒã€‚

åªéœ€å¦‚ä¸‹å‡ æ¡å‘½ä»¤å³å¯å®Œæˆè‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ï¼š

```bash
docker compose up -d
./run_tests
docker compose down
```

è¿™æ ·ä½ å¯ä»¥åœ¨æµ‹è¯•å‰å¿«é€Ÿéƒ¨ç½²ç¯å¢ƒï¼Œæµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†èµ„æºã€‚

---

#### ğŸ§© å•æœºéƒ¨ç½²

è™½ç„¶ Compose æœ€åˆæ˜¯ä¸ºå¼€å‘å’Œæµ‹è¯•åœºæ™¯è®¾è®¡çš„ï¼Œä½†ç°åœ¨è¶Šæ¥è¶Šå¤šåœ°å¼•å…¥äº†é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ç‰¹æ€§ã€‚

è‹¥æƒ³äº†è§£ Compose åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„ï¼š[Compose in production](https://docs.docker.com/compose/production/)ã€‚

---

## **Docker Compose çš„å†å²ä¸å‘å±•**

æœ¬é¡µé¢æä¾›äº†ï¼š

* Docker Compose CLI çš„å‘å±•ç®€å²
* ç»„æˆ Compose v1 å’Œ Compose v2 çš„ä¸»è¦ç‰ˆæœ¬å’Œæ–‡ä»¶æ ¼å¼çš„æ¸…æ™°è§£é‡Š
* Compose V1 å’Œ Compose v2 ä¹‹é—´çš„ä¸»è¦åŒºåˆ«

### **ç®€ä»‹**

![Docker Compose CLI ç‰ˆæœ¬ç®¡ç†](https://docs.docker.com/compose/images/v1-versus-v2.png)

ä¸Šä¸€å¼ å›¾å±•ç¤ºäº† Compose v1 å’Œ Compose v2 ä¹‹é—´çš„ä¸»è¦åŒºåˆ«ã€‚å½“å‰æ”¯æŒçš„ Docker Compose CLI ç‰ˆæœ¬æ˜¯ Compose v2ï¼Œå®ƒç”± Compose è§„èŒƒå®šä¹‰ã€‚

å®ƒè¿˜å¿«é€Ÿå±•ç¤ºäº†æ–‡ä»¶æ ¼å¼ã€å‘½ä»¤è¡Œè¯­æ³•å’Œé¡¶çº§å…ƒç´ çš„å·®å¼‚ã€‚ä»¥ä¸‹éƒ¨åˆ†å°†æ›´è¯¦ç»†åœ°ä»‹ç»è¿™äº›å†…å®¹ã€‚

### **Docker Compose CLI ç‰ˆæœ¬ç®¡ç†**

Docker Compose å‘½ä»¤è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬äº 2014 å¹´å‘å¸ƒã€‚å®ƒæ˜¯ç”¨ Python ç¼–å†™çš„ï¼Œé€šè¿‡ `docker-compose` è°ƒç”¨ã€‚é€šå¸¸ï¼ŒCompose V1 é¡¹ç›®åœ¨ `compose.yaml` æ–‡ä»¶ä¸­åŒ…å«ä¸€ä¸ªé¡¶çº§ç‰ˆæœ¬å…ƒç´ ï¼Œç‰ˆæœ¬å·èŒƒå›´ä» 2.0 åˆ° 3.8ï¼Œè¿™äº›ç‰ˆæœ¬å·æŒ‡ä»£ç‰¹å®šçš„æ–‡ä»¶æ ¼å¼ã€‚

Docker Compose å‘½ä»¤è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¬äºŒä¸ªç‰ˆæœ¬äº 2020 å¹´å‘å¸ƒï¼Œæ˜¯ç”¨ Go ç¼–å†™çš„ï¼Œé€šè¿‡ `docker compose` è°ƒç”¨ã€‚Compose v2 ä¼šå¿½ç•¥ `compose.yaml` æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬é¡¶çº§å…ƒç´ ã€‚

### **Compose æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬ç®¡ç†**

Docker Compose CLI æ˜¯ç”±ç‰¹å®šçš„æ–‡ä»¶æ ¼å¼å®šä¹‰çš„ã€‚

Compose V1 æœ‰ä¸‰ä¸ªä¸»è¦çš„æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å‘å¸ƒï¼š

* Compose æ–‡ä»¶æ ¼å¼ 1ï¼Œéš Compose 1.0.0 äº 2014 å¹´å‘å¸ƒ
* Compose æ–‡ä»¶æ ¼å¼ 2.xï¼Œéš Compose 1.6.0 äº 2016 å¹´å‘å¸ƒ
* Compose æ–‡ä»¶æ ¼å¼ 3.xï¼Œéš Compose 1.10.0 äº 2017 å¹´å‘å¸ƒ

Compose æ–‡ä»¶æ ¼å¼ 1 ä¸åç»­æ‰€æœ‰æ ¼å¼æœ‰æ˜¾è‘—ä¸åŒï¼Œå› ä¸ºå®ƒç¼ºå°‘é¡¶çº§çš„ `services` é”®ã€‚å®ƒçš„ä½¿ç”¨å†å²æ‚ ä¹…ï¼Œä½¿ç”¨è¿™ç§æ ¼å¼ç¼–å†™çš„æ–‡ä»¶æ— æ³•åœ¨ Compose v2 ä¸Šè¿è¡Œã€‚

Compose æ–‡ä»¶æ ¼å¼ 2.x å’Œ 3.x éå¸¸ç›¸ä¼¼ï¼Œä½†åè€…å¼•å…¥äº†è®¸å¤šé’ˆå¯¹ Swarm éƒ¨ç½²çš„æ–°é€‰é¡¹ã€‚

ä¸ºäº†å¤„ç† Compose CLI ç‰ˆæœ¬ç®¡ç†ã€Compose æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬ç®¡ç†å’Œæ ¹æ®æ˜¯å¦ä½¿ç”¨ Swarm æ¨¡å¼è€Œäº§ç”Ÿçš„åŠŸèƒ½å·®å¼‚ï¼Œæ–‡ä»¶æ ¼å¼ 2.x å’Œ 3.x è¢«åˆå¹¶åˆ° Compose è§„èŒƒä¸­ã€‚

**Compose v2 ä½¿ç”¨ Compose è§„èŒƒè¿›è¡Œé¡¹ç›®å®šä¹‰ã€‚** ä¸ä¹‹å‰çš„æ–‡ä»¶æ ¼å¼ä¸åŒï¼ŒCompose è§„èŒƒæ˜¯æ»šåŠ¨æ›´æ–°çš„ï¼Œå¹¶ä½¿å¾—ç‰ˆæœ¬é¡¶çº§å…ƒç´ æˆä¸ºå¯é€‰é¡¹ã€‚Compose v2 è¿˜åˆ©ç”¨äº†å¯é€‰çš„è§„èŒƒ â€” éƒ¨ç½²ã€å¼€å‘å’Œæ„å»ºã€‚

ä¸ºäº†ä½¿è¿ç§»æ›´å®¹æ˜“ï¼ŒCompose v2 å¯¹ Compose æ–‡ä»¶æ ¼å¼ 2.x/3.x å’Œ Compose è§„èŒƒä¹‹é—´å·²å¼ƒç”¨æˆ–æ›´æ”¹çš„æŸäº›å…ƒç´ æä¾›äº†å‘åå…¼å®¹æ€§ã€‚


# How-tos
åœ¨æŠ€æœ¯æ–‡æ¡£ï¼ˆå¦‚ Docker å®˜æ–¹æ‰‹å†Œï¼‰ä¸­ï¼Œ**How-tos** æ˜¯ **â€œHow to do somethingâ€** çš„ç¼©å†™ï¼Œä¸­æ–‡å¸¸è¯‘ä¸º **â€œæ“ä½œæŒ‡å—â€** æˆ– **â€œå®è·µæ•™ç¨‹â€**ã€‚è¿™ç±»å†…å®¹ä¸“æ³¨äº **å…·ä½“é—®é¢˜çš„è§£å†³æ–¹æ³•** å’Œ **åˆ†æ­¥éª¤çš„æ“ä½œæŒ‡å¯¼**ï¼Œé€šå¸¸åŒ…å«ï¼š

---

## ğŸ“– æ ¸å¿ƒå«ä¹‰
- **å­—é¢æ„ä¹‰**ï¼š*â€œå¦‚ä½•åšæŸäº‹â€* çš„å¤æ•°å½¢å¼ï¼Œå³ä¸€ç³»åˆ—å…·ä½“ä»»åŠ¡çš„å®ç°æŒ‡å—ã€‚
- **æ–‡æ¡£å®šä½**ï¼šä»‹äºç†è®ºæ¦‚å¿µï¼ˆå¦‚ *Introduction*ï¼‰ä¸å‘½ä»¤å‚è€ƒæ‰‹å†Œï¼ˆå¦‚ *CLI Reference*ï¼‰ä¹‹é—´çš„**å®è·µæ€§å†…å®¹**ã€‚
- **ä¸­æ–‡å¯¹åº”**ï¼šç±»ä¼¼â€œä½¿ç”¨æŠ€å·§â€â€œå®æˆ˜æ•™ç¨‹â€â€œæ“ä½œæ‰‹å†Œâ€ç­‰è¡¨è¿°ã€‚

---

## ä½¿ç”¨ Compose Watch

**è¦æ±‚ï¼š**
Docker Compose 2.22.0 æˆ–æ›´é«˜ç‰ˆæœ¬

`watch` å±æ€§ä¼šåœ¨ä½ ç¼–è¾‘å¹¶ä¿å­˜ä»£ç æ—¶ï¼Œ**è‡ªåŠ¨æ›´æ–°å¹¶é¢„è§ˆ**æ­£åœ¨è¿è¡Œçš„ Compose æœåŠ¡ã€‚å¯¹äºè®¸å¤šé¡¹ç›®æ¥è¯´ï¼Œä¸€æ—¦ Compose å¯åŠ¨ï¼Œè¿™å°±å®ç°äº†ä¸€ä¸ªå‡ ä¹**æ— éœ€æ‰‹åŠ¨å¹²é¢„**çš„å¼€å‘æµç¨‹â€”â€”æœåŠ¡ä¼šåœ¨ä½ ä¿å­˜å·¥ä½œæ—¶è‡ªåŠ¨æ›´æ–°è‡ªå·±ã€‚

watch éµå¾ªä»¥ä¸‹æ–‡ä»¶è·¯å¾„è§„åˆ™ï¼š

* æ‰€æœ‰è·¯å¾„ç›¸å¯¹äºé¡¹ç›®ç›®å½•ï¼ˆignore æ–‡ä»¶æ¨¡å¼é™¤å¤–ï¼‰
* ç›®å½•ä¼šè¢«é€’å½’ç›‘å¬
* **ä¸æ”¯æŒ**é€šé…ç¬¦ï¼ˆglob patternsï¼‰
* éµå¾ª `.dockerignore` ä¸­çš„è§„åˆ™
* å¯é€šè¿‡ `ignore` é€‰é¡¹å®šä¹‰é¢å¤–å¿½ç•¥çš„è·¯å¾„ï¼ˆè¯­æ³•ç›¸åŒï¼‰
* å¸¸è§ IDEï¼ˆå¦‚ Vimã€Emacsã€JetBrains ç­‰ï¼‰ç”Ÿæˆçš„ä¸´æ—¶/å¤‡ä»½æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨å¿½ç•¥
* `.git` ç›®å½•ä¼šè¢«è‡ªåŠ¨å¿½ç•¥

ä½ **ä¸éœ€è¦**å¯¹ Compose é¡¹ç›®ä¸­çš„æ‰€æœ‰æœåŠ¡éƒ½å¯ç”¨ `watch`ã€‚åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œæ¯”å¦‚ä»…éœ€è¦å‰ç«¯ï¼ˆå¦‚ JavaScriptï¼‰æ”¯æŒè‡ªåŠ¨æ›´æ–°å³å¯ã€‚

> âš ï¸ Compose Watch ä»…é€‚ç”¨äºä½¿ç”¨ `build` å±æ€§æ„å»ºæœ¬åœ°æºä»£ç çš„æœåŠ¡ã€‚å®ƒä¸ä¼šè¿½è¸ªé‚£äº›é€šè¿‡ `image` å±æ€§ä½¿ç”¨é¢„æ„å»ºé•œåƒçš„æœåŠ¡ã€‚

---

### Compose Watch ä¸ç»‘å®šæŒ‚è½½ï¼ˆbind mountï¼‰çš„åŒºåˆ«

Compose æ”¯æŒå°†ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚`watch` å¹¶**ä¸æ˜¯æ›¿ä»£**è¿™é¡¹åŠŸèƒ½ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ç§**è¡¥å……æœºåˆ¶**ï¼Œæ›´é€‚åˆåœ¨å®¹å™¨ä¸­è¿›è¡Œå¼€å‘ã€‚

æ¯”èµ· bind mountï¼Œ`watch` æä¾›äº†**æ›´ç²¾ç»†çš„æ§åˆ¶èƒ½åŠ›**ï¼Œå…è®¸ä½ å¿½ç•¥ç‰¹å®šæ–‡ä»¶æˆ–æ•´ä¸ªç›®å½•ã€‚

ä¾‹å¦‚ï¼Œåœ¨ JavaScript é¡¹ç›®ä¸­å¿½ç•¥ `node_modules/` æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š

* **æ€§èƒ½æå‡**ï¼šåŒ…å«å¤§é‡å°æ–‡ä»¶çš„æ–‡ä»¶æ ‘åœ¨æŸäº›é…ç½®ä¸­ä¼šäº§ç”Ÿå¾ˆé«˜çš„ I/O è´Ÿè½½
* **è·¨å¹³å°å…¼å®¹**ï¼šå¦‚æœå®¿ä¸»æœºå’Œå®¹å™¨çš„ç³»ç»Ÿæ¶æ„ä¸åŒï¼Œåˆ™æ— æ³•å…±äº«ç¼–è¯‘äº§ç‰©

ä¾‹å¦‚åœ¨ Node.js é¡¹ç›®ä¸­ï¼Œä¸å»ºè®®åŒæ­¥ `node_modules/`ï¼Œå³ä¾¿ JS æ˜¯è§£é‡Šå‹è¯­è¨€ï¼Œnpm åŒ…ä¸­ä¹Ÿå¯èƒ½åŒ…å«è·¨å¹³å°ä¸å…¼å®¹çš„æœ¬åœ°ä»£ç ã€‚

---

### é…ç½®è¯´æ˜

`watch` å±æ€§ç”¨äºå®šä¹‰è§„åˆ™ï¼ŒåŸºäºæœ¬åœ°æ–‡ä»¶çš„æ›´æ”¹æ¥è‡ªåŠ¨æ›´æ–°æœåŠ¡ã€‚

æ¯æ¡è§„åˆ™å¿…é¡»æŒ‡å®šï¼š

* ä¸€ä¸ªè·¯å¾„ï¼ˆpathï¼‰
* ä¸€ä¸ªæ“ä½œç±»å‹ï¼ˆactionï¼‰ï¼šå¯é€‰å€¼ä¸ºï¼š

  * `sync`ï¼šåŒæ­¥æ–‡ä»¶
  * `rebuild`ï¼šé‡æ–°æ„å»ºé•œåƒå¹¶æ›¿æ¢æœåŠ¡
  * `sync+restart`ï¼šåŒæ­¥åé‡å¯å®¹å™¨

> è¿™äº›è§„åˆ™é€‚ç”¨äºå¤šç§è¯­è¨€å’Œæ¡†æ¶ï¼Œå…·ä½“è·¯å¾„å’Œè¡Œä¸ºæŒ‰é¡¹ç›®è€Œå®šï¼Œä½†åŸç†é€šç”¨ã€‚

#### å‰ææ¡ä»¶

å®¹å™¨é•œåƒä¸­åº”åŒ…å«ä»¥ä¸‹å¸¸ç”¨å¯æ‰§è¡Œæ–‡ä»¶ï¼š

* `stat`
* `mkdir`
* `rmdir`

æ­¤å¤–ï¼Œå®¹å™¨çš„ `USER` ç”¨æˆ·éœ€è¦æœ‰**å†™å…¥æƒé™**ï¼Œé€šå¸¸ä½ å¯ä»¥ä½¿ç”¨ Dockerfile ä¸­çš„ `COPY --chown` æŒ‡ä»¤æ¥è®¾ç½®åˆå§‹æ–‡ä»¶çš„æ‰€æœ‰è€…ï¼Œä¾‹å¦‚ï¼š

```dockerfile
# ä»¥é root ç”¨æˆ·è¿è¡Œ
FROM node:18
RUN useradd -ms /bin/sh -u 1001 app
USER app

# å®‰è£…ä¾èµ–
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm install

# æ‹·è´æºä»£ç å¹¶è®¾ç½®æ‰€æœ‰è€…
COPY --chown=app:app . /app
```

---

#### å„ç§æ“ä½œè¯´æ˜

##### 1. `sync`

* ä½œç”¨ï¼šè‡ªåŠ¨å°†å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶å˜æ›´åŒæ­¥åˆ°å®¹å™¨å†…å¯¹åº”è·¯å¾„
* é€‚ç”¨åœºæ™¯ï¼šæ”¯æŒâ€œçƒ­é‡è½½â€ï¼ˆHot Reloadï¼‰çš„æ¡†æ¶ï¼Œå¦‚å‰ç«¯å¼€å‘

##### 2. `rebuild`

* ä½œç”¨ï¼šè‡ªåŠ¨ä½¿ç”¨ BuildKit é‡æ–°æ„å»ºé•œåƒï¼Œå¹¶æ›¿æ¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨
* ç­‰ä»·äºå‘½ä»¤ï¼š`docker compose up --build <æœåŠ¡å>`
* é€‚åˆåœºæ™¯ï¼šç¼–è¯‘å‹è¯­è¨€æˆ–éœ€å®Œæ•´æ„å»ºçš„æ–‡ä»¶å˜åŠ¨ï¼ˆå¦‚ `package.json`ï¼‰

##### 3. `sync+restart`

* ä½œç”¨ï¼šåŒæ­¥æ–‡ä»¶åé‡å¯æœåŠ¡
* é€‚åˆåœºæ™¯ï¼šé…ç½®æ–‡ä»¶æ›´æ”¹ï¼ˆå¦‚æ•°æ®åº“æˆ– nginx é…ç½®ï¼‰ï¼Œæ— éœ€é‡å»ºé•œåƒï¼Œåªéœ€é‡å¯æœåŠ¡ä¸»è¿›ç¨‹

---

#### `path` å’Œ `target`

* `path`ï¼šç›‘å¬çš„æœ¬åœ°è·¯å¾„
* `target`ï¼šå®¹å™¨ä¸­çš„ç›®æ ‡è·¯å¾„

ä¾‹å¦‚ï¼š

```yaml
path: ./app/html
target: /app/html
```

å½“ä½ ä¿®æ”¹äº† `./app/html/index.html`ï¼Œåˆ™æ–‡ä»¶ä¼šè¢«åŒæ­¥åˆ° `/app/html/index.html`ã€‚

---

#### `ignore` å¿½ç•¥è§„åˆ™

`ignore` çš„è·¯å¾„æ˜¯**ç›¸å¯¹äºå½“å‰ `watch` åŠ¨ä½œä¸­çš„ `path` è·¯å¾„**ï¼Œè€Œä¸æ˜¯é¡¹ç›®æ ¹ç›®å½•ã€‚

---

### ç¤ºä¾‹ 1ï¼šNode.js é¡¹ç›®

é¡¹ç›®ç»“æ„ï¼š

```
myproject/
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ App.jsx
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ node_modules/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ compose.yaml
â””â”€â”€ package.json
```

Compose é…ç½®ï¼š

```yaml
services:
  web:
    build: .
    command: npm start
    develop:
      watch:
        - action: sync
          path: ./web
          target: /src/web
          ignore:
            - node_modules/
        - action: rebuild
          path: package.json
```

è¿è¡Œ `docker compose up --watch` åï¼š

* å¯åŠ¨æœåŠ¡ï¼Œè¿è¡Œ `npm start`
* å¯ç”¨æ–‡ä»¶ç›‘å¬ï¼šå½“ä½ ç¼–è¾‘ `web/` ä¸­çš„æ–‡ä»¶ï¼ŒCompose ä¼šå°†å…¶åŒæ­¥åˆ°å®¹å™¨å†… `/src/web/`
* å¿½ç•¥äº† `node_modules/` ç›®å½•çš„å˜åŠ¨
* å¦‚æœ `package.json` å‘ç”Ÿæ›´æ”¹ï¼Œä¼šè§¦å‘é‡æ–°æ„å»ºé•œåƒ

---

### ç¤ºä¾‹ 2ï¼šåŠ ä¸Š `sync+restart`

```yaml
services:
  web:
    build: .
    command: npm start
    develop:
      watch:
        - action: sync
          path: ./web
          target: /app/web
          ignore:
            - node_modules/
        - action: sync+restart
          path: ./proxy/nginx.conf
          target: /etc/nginx/conf.d/default.conf

  backend:
    build:
      context: backend
      target: builder
```

è¿™ä¸ªé…ç½®å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `sync+restart` æ¥æ›´æ–° nginx é…ç½®å¹¶é‡å¯æœåŠ¡ï¼ŒåŒæ—¶å‰ç«¯ä»£ç ä½¿ç”¨ `sync` å®æ—¶çƒ­æ›´æ–°ï¼Œåç«¯ä½¿ç”¨æ„å»ºç›®æ ‡åˆ†ç¦»ã€‚

---

### å¦‚ä½•ä½¿ç”¨ watch

1. åœ¨ `compose.yaml` ä¸­ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡æ·»åŠ  `watch` é…ç½®
2. æ‰§è¡Œå‘½ä»¤ï¼š

   ```bash
   docker compose up --watch
   ```
3. ä½¿ç”¨ä½ çš„ç¼–è¾‘å™¨ç¼–è¾‘æœåŠ¡æºä»£ç 

> ğŸ’¡ å¦‚æœä½ ä¸æƒ³æŠŠåº”ç”¨æ—¥å¿—å’ŒåŒæ­¥æ—¥å¿—æ··åˆåœ¨ä¸€èµ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸“é—¨çš„å‘½ä»¤ï¼š
> `docker compose watch`

---

### ç¤ºä¾‹é¡¹ç›®ä¸åé¦ˆ

ä½ å¯ä»¥å‚è€ƒå®˜æ–¹ç¤ºä¾‹é¡¹ç›®ï¼š

* [dockersamples/avatars](https://github.com/dockersamples/avatars)
* Docker æ–‡æ¡£çš„æœ¬åœ°å¼€å‘é…ç½®ç¤ºä¾‹

æ¬¢è¿å‰å¾€ [Compose Specification ä»“åº“](https://github.com/compose-spec/compose-spec) æäº¤åé¦ˆæˆ–æŠ¥å‘Šé—®é¢˜ã€‚

---

å¦‚éœ€è¿›ä¸€æ­¥é…ç½®è¯´æ˜ï¼Œå¯æŸ¥é˜…ï¼š[Compose Develop è§„èŒƒï¼ˆCompose Develop Specificationï¼‰](https://github.com/compose-spec/compose-spec/blob/main/develop.md)




